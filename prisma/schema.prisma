// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== 共享表 ==========

/// 用户表（微信用户）
model User {
  id       String  @id @default(uuid())
  openid   String  @unique /// 微信 openid
  nickname String? /// 微信昵称
  avatar   String? /// 微信头像
  phone    String? /// 手机号

  // 黑名单功能
  isBlacklisted   Boolean   @default(false) @map("is_blacklisted") /// 是否拉黑
  blacklistedAt   DateTime? @map("blacklisted_at") /// 拉黑时间
  blacklistReason String?   @map("blacklist_reason") /// 拉黑原因

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // 关联关系
  unitelOrders UnitelOrder[]

  @@index([isBlacklisted])
  @@map("users")
}

/// 管理员表
model Admin {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String
  email     String?
  role      String   @default("admin")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("admins")
}

// ========== Unitel 运营商表 ==========

/// Unitel订单表
model UnitelOrder {
  id String @id @default(uuid())

  // 用户信息
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  // 订单基本信息
  orderNo   String @unique @map("order_no") /// 订单号
  msisdn    String /// 手机号码
  orderType String @map("order_type") /// 订单类型: balance(话费) | data(流量) | invoice_payment(账单支付)

  // 金额信息（双币种）
  amountMnt    Decimal  @map("amount_mnt") @db.Decimal(10, 2) /// 蒙古国货币金额(MNT)
  amountCny    Decimal  @map("amount_cny") @db.Decimal(10, 2) /// 人民币金额(CNY)
  exchangeRate Decimal? @map("exchange_rate") @db.Decimal(10, 4) /// 汇率快照

  // 产品信息（资费列表字段）
  packageCode    String  @map("package_code") /// 套餐代码
  productName    String  @map("product_name") /// 套餐名称（蒙古语）
  productEngName String  @map("product_eng_name") /// 套餐英文名称
  productUnit    Int?    @map("product_unit") /// 话费单位
  productData    String? @map("product_data") /// 流量大小（如"3GB"）
  productDays    Int?    @map("product_days") /// 有效期天数

  // 状态管理
  paymentStatus  String @map("payment_status") /// 支付状态: unpaid | paid | refunded
  rechargeStatus String @map("recharge_status") /// 充值状态: pending | processing | success | failed

  // Unitel API 特有字段
  svId   String? @map("sv_id") /// Unitel服务ID
  seq    String? /// Unitel序列号
  method String? /// 支付方式

  // VAT 发票信息 (JSON存储)
  vatFlag       String? @map("vat_flag") /// VAT标志 1=开发票, 0=不开
  vatRegisterNo String? @map("vat_register_no") /// VAT注册号
  vatInfo       Json?   @map("vat_info") /// 完整的VAT发票信息

  // API 响应信息
  apiResult String? @map("api_result") /// API返回的result字段
  apiCode   String? @map("api_code") /// API返回的code字段
  apiMsg    String? @map("api_msg") /// API返回的msg字段
  apiRaw    Json?   @map("api_raw") /// 完整的API响应(用于调试)

  // 错误信息
  errorMessage String? @map("error_message") /// 错误消息
  errorCode    String? @map("error_code") /// 错误代码

  // 时间戳
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  paidAt      DateTime? @map("paid_at") /// 支付时间
  completedAt DateTime? @map("completed_at") /// 完成时间

  @@index([userId])
  @@index([orderNo])
  @@index([msisdn])
  @@index([paymentStatus])
  @@index([rechargeStatus])
  @@index([orderType])
  @@index([createdAt])
  @@map("unitel_orders")
}
